(function($){ // Begin anonymous function to avoid polluting the global namespace

// Initialize variables and options
var REDRAW_ATTEMPTS = 10;
var REDRAW_SHRINK = .95;
var canvas = null;
var target = null;
var options = null;
var maxRadius = null;
var centerLeft = null;
var centerTop = null;
var processed = false;
var ctx = null;
var highlights = [];

// Initialize the plot
function init(plot) {
  // Add hooks to process options, bind events, process datapoints, draw overlay, and draw chart
}

// Process datapoints
function processDatapoints(plot, series, data, datapoints) {
  // Combine data points based on the combine threshold
}

// Draw the chart
function draw(plot, newCtx) {
  // Clear the canvas and set up variables for drawing
  // Draw the pie chart, labels, and donut hole
}

// Draw the overlay
function drawOverlay(plot, octx) {
  // Draw highlights and donut hole on the overlay
}

// Helper functions for drawing shadows, slices, and labels

// Initialize options for the pie plugin
var options = {
  series: {
    pie: {
      show: false,
      radius: "auto",
      innerRadius: 0,
      startAngle: 3/2,
      tilt: 1,
      shadow: {
        left: 5,
        top: 15,
        alpha: .02
      },
      offset: {
        top: 0,
        left: "auto"
      },
      stroke: {
        color: "#fff",
        width: 1
      },
      label: {
        show: "auto",
        formatter: function(label, slice) {
          return "<div style='font-size:x-small;text-align:center;padding:2px;color:"+slice.color+";'>"+label+"<br/>"+Math.round(slice.percent)+"%</div>";
        },
        radius: 1,
        background: {
          color: null,
          opacity: 0
        },
        threshold: 0
      },
      combine: {
        threshold: -1,
        color: null,
        label: "Other"
      },
      highlight: {
        opacity: .5
      }
    }
  }
};

// Register the pie plugin with Flot
$.plot.plugins.push({
  init: init,
  options: options,
  name: "pie",
  version: "1.1"
});

})(jQuery); // End anonymous function
