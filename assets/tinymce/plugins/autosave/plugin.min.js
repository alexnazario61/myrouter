tinymce.PluginManager.add('autosave', function(editor) {
  const timeout = (time, unit) => {
    const settings = { s: 1000, m: 60000 };
    time = /^(\d+)([ms]?)$/.exec('' + (time || unit));
    return time[2] ? settings[time[2]] : 1 * parseInt(time[1], 10);
  }

  const n = () => {
    const timeInStorage = parseInt(localStorage.getItem(uid + "time"), 10) || 0;
    return (new Date()).getTime() - timeInStorage > f.autosave_retention
      ? (removeDraft(!1), !1)
      : !0;
  }

  const removeDraft = (removeNow) => {
    localStorage.removeItem(uid + "draft");
    localStorage.removeItem(uid + "time");
    removeNow !== !1 && editor.fire("RemoveDraft");
  }

  const storeDraft = () => {
    localStorage.setItem(uid + "draft", editor.getContent({ format: "raw", no_events: !0 }));
    localStorage.setItem(uid + "time", (new Date()).getTime());
    editor.fire("StoreDraft");
  }

  const restoreDraft = () => {
    editor.setContent(localStorage.getItem(uid + "draft"), { format: "raw" });
    editor.fire("RestoreDraft");
  }

  const hasDraft = () => {
    return n() && editor.isDirty()
      ? (storeDraft(), !1)
      : !0;
  }

  const uid = f.autosave_prefix || "tinymce-autosave-{path}{query}-{id}-";
  uid = uid.replace(/\{path\}/g, document.location.pathname);
  uid = uid.replace(/\{query\}/g, document.location.search);
  uid = uid.replace(/\{id\}/g, editor.id);
  f.autosave_interval = timeout(f.autosave_interval, "30s");
  f.autosave_retention = timeout(f.autosave_retention, "20m");

  const addButtonAndMenuItem = () => {
    const t = editor;
    t.ui.registry.addButton('restoredraft', {
      text: 'Restore draft',
      onAction: restoreDraft,
      onSetup: enabled
    });
    t.ui.registry.addMenuItem('restoredraft', {
      text: 'Restore draft',
      onAction: restoreDraft,
      onShow: enabled,
      context: 'file'
    });
  }

  const enabled = () => {
    const t = editor;
    t.disabled(!n());
    t.on('StoreDraft RestoreDraft RemoveDraft', function() {
      t.disabled(!n());
    });
  }

  editor.on('Init', function() {
    addButtonAndMenuItem();
  });


