// Adds a "colorpicker" plugin to TinyMCE
tinymce.PluginManager.add("colorpicker", function(editor) {

    // Function to open the color picker dialog
    function openColorPicker(currentColor, callback) {

        // Function to handle changes to the color picker
        function onColorPickerChange(newColor) {
            var rgbColor = new tinymce.util.Color(newColor).toRgb();
            o.find("#r").value(rgbColor.r);
            o.find("#g").value(rgbColor.g);
            o.find("#b").value(rgbColor.b);
            o.find("#hex").value(newColor.substr(1));
            updatePreview(newColor);
            currentColor = newColor;
        }

        // Function to update the color preview in the dialog
        function updatePreview(color) {
            o.find("#preview")[0].getEl().style.background = color;
        }

        // Open the color picker dialog
        var win = editor.windowManager.open({
            title: "Color",
            items: {
                type: "container",
                layout: "flex",
                direction: "row",
                align: "stretch",
                padding: 5,
                spacing: 10,
                items: [
                    {
                        type: "colorpicker",
                        value: currentColor,
                        onchange: onColorPickerChange
                    },
                    {
                        type: "form",
                        padding: 0,
                        labelGap: 5,
                        defaults: {
                            type: "textbox",
                            size: 7,
                            value: "0",
                            flex: 1,
                            spellcheck: false,
                            onchange: function() {
                                var name = this.name(),
                                    value = this.value();

                                if (name === "hex") {
                                    value = "#" + value;
                                    onColorPickerChange
